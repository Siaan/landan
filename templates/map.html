<!DOCTYPE html>
<html>
<head>
	<title>Phomo</title>
	<link rel="stylesheet" 
	href="https://fonts.googleapis.com/css?family=Raleway">
	<style>
	body {
		padding: 0px;
		margin: 0px;
	}

	#map {
		height: 900px;
		width: 100%;
	}

	#navbar {
		position: absolute;
		width: 400px;
		height: 100%;
		text-align: center;
		margin: 0;
		font-size: 50px;
		font-family: 'Raleway', sans-serif;
		box-shadow: 0px 1px 5px grey;
		z-index: 999;
		background-color: white;
	}

	#image-preview {
		width:100%;
	}

	#navbar-button {
		height: 30px;
		width: 30px;
	}

	#navbar-button:hover {
		cursor: pointer;
	}

	#top-navbar-container {
		display: flex;
		justify-content: space-around;
		align-items: center;
	}

	#search-bar {
		width: 260px;
		border: 0px;
		padding:10px;
	}

	#search-submit {
		background-color: white;
		padding: 3px;
		border-radius: 20px;
		height:30px;
		width: 30px;
	}

	#search-submit:hover {
		background-color: #EEEEEE;
		cursor: pointer;
	}

	.image-overlay {
		font-family: Raleway, sans-serif;
		color: black;
		text-align: left;
		padding: 5px;
	}

	.image-container {
		text-decoration: none;
	}
</style>
</head>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAF1LsdlbXpfEI1sx8WK4VqvMpbsKowHRE&libraries=visualization&callback=initMap" type="text/javascript"> </script>
<div id="navbar">
	<div id="top-navbar-container">
		<img id="navbar-button" src="http://www.contentformula.com/blog/wp-content/uploads/2016/06/hamburger-menu.png" onclick="handleSideBar()" />
		<input id="search-bar" type="text" name="location" placeholder="enter a location..."><br>
		<img id="search-submit" src="https://cdn4.iconfinder.com/data/icons/ionicons/512/icon-ios7-search-strong-128.png" onclick="search()" />
	</div>
	<div id="image-preview"></div>
</div>
<div id="map"></div>
<script type="text/javascript">
	var map;
	var sidebarClosed = false;
	//Initiallize map with user's current location
	if (navigator.geolocation) {
		navigator.geolocation.getCurrentPosition(initMap);
	} else { 
		document.getElementById("map").innerHTML = "Geolocation is not supported by this browser.";
	}

	function initMap(position){
		let location = {lat: 41.850033, lng: -87.6500523}; //defaults to center of America
		if(position){
			location = {
				lat: position.coords.latitude,
				lng: position.coords.longitude
			};
		}
		
		map = new google.maps.Map(document.getElementById('map'), {
          zoom: 15,
          center: location,
        });

        google.maps.event.addListener(map, 'bounds_changed', function() {
        	let bounds = map.getBounds();

        	//JSON Object to send to server
        	let halfWidth = bounds.ga.l - bounds.ga.j;
        	let halfHeight = bounds.ma.l - bounds.ma.j
        	let center = map.getCenter();

        	let centerPoint = {
        		lat: center.lat(),
        		lng: center.lng()
        	}

        	let frameInfo = {
        		center: centerPoint,
        		halfWidth: halfWidth,
        		halfHeight: halfHeight
        	};

        	//send to server
        	//TODO

        	//get the data
	        let locations = getLocationData();
	        drawMarkers(locations);
        }); 
	}

	// google.maps.event.addListener(map, 'bounds_changed', function(){
	// 	var bounds =  map.getBounds();
	// 	let ne = bounds.getNorthEast();
	// 	let sw = bounds.getSouthWest();
	// 	console.log(ne);
	// 	console.log(sw);
	// });

	function getLocationData(){
		const Http = new XMLHttpRequest();
		const url = 'https://jsonplaceholder.typicode.com/posts';
		Http.open("GET",url);
		Http.send();

		Http.onreadystatechange=(e)=>{
			return Http.responseText;
		}
	}

	function drawMarkers(locations){
		//debuggin
		let test = [
		{
			lat: 52.2018816, 
			lng: 0.1089536,
			farm: 5,
			server: 4906,
			secret:  'cf53e2a5eb',
			photoID: 31863524357,
		}
		];

		let images = document.getElementById("image-preview");
		images.innerHTML = null;
		for(let i = 0; i < test.length; i++){

			let location = {
				lat: test[i].lat,
				lng: test[i].lng
			};

			var point = new google.maps.Circle({
				strokeColor: '#FF0000',
				strokeOpacity: 0.8,
				strokeWeight: 2,
				fillColor: '#FF0000',
				fillOpacity: 0.35,
				map: map,
				center: location,
				radius: 50
			});

			handleImage(test[i],images);
		}
	}

	function handleImage(image,images){
		//get information about photo
		let url = "https://api.flickr.com/services/rest/?method=flickr.photos.getInfo&api_key=c5ffff1a95a4ab5a9e440d76ad56f247&photo_id=" + image.photoID + "&secret=" + image.secret + "&format=json&nojsoncallback=1";

		let request = new XMLHttpRequest();
		request.open('GET',url,true);

		request.onload = function(){
			let data = JSON.parse(this.response);

			let imageSource = "https://www.flickr.com/photos/" + data.photo.owner.nsid + "/"+ image.photoID +"/in/feed";
			images.innerHTML += 
			"<a class=\"image-container\" href=\"" + imageSource +
			"\"target=\"_blank\"><img id='" + image.photoID +
			"'width=\"100%\" src='https://farm" + 
			image.farm+'.staticflickr.com/'+
			image.server+'/'+image.photoID+'_'+
			image.secret+'.jpg' + "'>" +  
			"<div class=\"image-overlay\"><p style=\"font-size:15px;margin:2px;\">" +
			data.photo.owner.username + "</p><p style=\"font-size:12px;margin:2px;\">" +
			data.photo.title._content +
			"</p></div>" +
			"</a>";
		}

		request.send();
	}

	function search(){
		console.log(document.getElementById("search-bar").value);
		//TODO
	}

	function handleSideBar(){
		let navbar = document.getElementById("navbar").style;
		let images = document.getElementById("image-preview").style;
		let searchBar = document.getElementById("search-bar").style;
		let searchSubmit = document.getElementById("search-submit").style;

		console.log(sidebarClosed);
		if(sidebarClosed){
			navbar.width = '400px';
			images.display = 'flex';
			searchBar.display = 'block';
			searchSubmit.display = 'block';
			sidebarClosed = false;
		}else{
			navbar.width = '40px';
			images.display = 'none';
			searchBar.display = 'none';
			searchSubmit.display = 'none';
			sidebarClosed = true;
		}
	}

</script>
<body>

</body>
</html>